@page "/"
@inject XmlParserService XmlParser
@inject CoverageService CoverageService
@inject IJSRuntime JS

<PageTitle>Coverage Report - Upload</PageTitle>

<h1>Upload Coverage Report</h1>

<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">Select Cobertura XML</label>
        <InputFile OnChange="HandleFileSelected" class="form-control" accept=".xml" />
    </div>
    <div class="col-md-6">
        @if (CoverageService.CurrentReport != null)
        {
            <label class="form-label">Report Date</label>
            <input type="date" class="form-control" @bind="CoverageService.CurrentReport.UploadDate" />
        }
    </div>
</div>

@if (ErrorMessage != null)
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (IsLoading)
{
    <div class="mb-4">
        <label class="form-label small fw-bold">PROCESSING: @(Math.Round(ProgressValue * 100))%</label>
        <div class="progress" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: @(ProgressValue * 100)%" 
                 aria-valuenow="@(ProgressValue * 100)" 
                 aria-valuemin="0" 
                 aria-valuemax="100"></div>
        </div>
        @if (EstimatedTimeRemaining > 0)
        {
            <div class="text-muted small mt-1">
                Estimated time remaining: @(Math.Round(EstimatedTimeRemaining / 1000.0, 1))s 
                (Based on historical speed: @(Math.Round(HistoricalSpeedBytesPerMs, 2)) bytes/ms)
            </div>
        }
    </div>
}

@if (CoverageService.CurrentReport != null)
{
    <div class="card mb-3 shadow-sm border-0">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white py-3">
            <h5 class="mb-0 fw-bold">Coverage Overview</h5>
            <button class="btn btn-sm btn-outline-light px-4 fw-bold" @onclick="SaveReport" disabled="@IsSaving">
                @if (IsSaving) { <span class="spinner-border spinner-border-sm me-2"></span> }
                SAVE TO HISTORY
            </button>
        </div>
        <div class="card-body bg-light border-bottom">
            <div class="row text-center">
                <div class="col-md-3 border-end">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Overall Core Content</div>
                    <div class="h4 mb-0 fw-bold @GetRateClass(CoverageService.CurrentReport.LineRate)">@CoverageService.CurrentReport.LineRate.ToString("P1")</div>
                    <div class="small text-muted mt-1">@CoverageService.CurrentReport.LinesCovered.ToString("N0") / @CoverageService.CurrentReport.LinesTotal.ToString("N0") lines</div>
                </div>
                <div class="col-md-3 border-end">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Core Logic (Services)</div>
                    <div class="h4 mb-0 text-primary fw-bold">@CoverageService.CurrentReport.CoreLineRate.ToString("P1")</div>
                    <div class="small text-muted mt-1">@CoverageService.CurrentReport.CoreLinesCovered.ToString("N0") / @CoverageService.CurrentReport.CoreLinesTotal.ToString("N0") lines</div>
                </div>
                <div class="col-md-3 border-end">
                    <div class="text-muted small text-uppercase fw-bold mb-1">WebAPI Controllers</div>
                    <div class="h4 mb-0 text-warning fw-bold">@CoverageService.CurrentReport.ControllerLineRate.ToString("P1")</div>
                    <div class="small text-muted mt-1">@CoverageService.CurrentReport.ControllerLinesCovered.ToString("N0") / @CoverageService.CurrentReport.ControllerLinesTotal.ToString("N0") lines</div>
                </div>
                <div class="col-md-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Branch Coverage</div>
                    <div class="h4 mb-0 text-secondary fw-bold">@CoverageService.CurrentReport.BranchRate.ToString("P1")</div>
                    <div class="small text-muted mt-1">Core Logic: @CoverageService.CurrentReport.CoreBranchRate.ToString("P1")</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="border-start border-4 border-primary ps-3 mb-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="h4">1. Business Logic & Core Services</h2>
                <p class="text-muted small">Excludes controllers and test modules. Focus on service-level metrics.</p>
            </div>
            <div class="card border-primary shadow-sm" style="max-width: 350px;">
                <div class="card-header bg-primary text-white py-1 px-3 small fw-bold">GOAL: 60% OVERALL COVERAGE</div>
                <div class="card-body py-2 px-3">
                    @{
                        long targetCovered = (long)Math.Ceiling(CoverageService.CurrentReport.LinesTotal * 0.60);
                        long gap = targetCovered - CoverageService.CurrentReport.LinesCovered;
                        long selectedImpact = CoverageService.CurrentReport.ClassDetails.Where(d => d.IsTarget).Sum(d => d.LinesTotal - d.LinesCovered);
                        double estimatedRate = CoverageService.CurrentReport.LinesTotal > 0 ? (double)(CoverageService.CurrentReport.LinesCovered + selectedImpact) / CoverageService.CurrentReport.LinesTotal : 0;
                    }
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">Required Additional:</span>
                        <span class="small fw-bold @(gap <= 0 ? "text-success" : "text-danger")">
                            @(gap <= 0 ? "Goal Reached!" : $"{gap:N0} lines")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small text-muted">Plan Impact:</span>
                        <span class="small fw-bold text-primary">+@selectedImpact.ToString("N0") lines</span>
                    </div>
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: @(CoverageService.CurrentReport.LineRate * 100)%"></div>
                        <div class="progress-bar bg-primary progress-bar-striped" role="progressbar" style="width: @((estimatedRate - CoverageService.CurrentReport.LineRate) * 100)%"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small fw-bold">Est: <span class="@GetRateClass(estimatedRate)">@estimatedRate.ToString("P1")</span></span>
                        <button class="btn btn-xs btn-outline-primary py-0" style="font-size: 0.7rem;" @onclick="AutoSelectTargets">AUTO-FILL GAP</button>
                    </div>
                </div>
            </div>
        </div>
        
        <h4 class="h6 mt-3 text-uppercase fw-bold">Logic Package Summaries</h4>
        <div class="table-responsive mb-3">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Package</th>
                        <th>Classes</th>
                        <th>Covered</th>
                        <th>Uncovered</th>
                        <th>Total</th>
                        <th>Line Rate</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var record in CoverageService.CurrentReport.Records.Where(r => r.PackageName.EndsWith(" (Logic)")))
                    {
                        <tr>
                            <td>@record.PackageName.Replace(" (Logic)", "")</td>
                            <td>@record.ClassCount</td>
                            <td>@record.LinesCovered.ToString("N0")</td>
                            <td class="text-danger">@((record.LinesTotal - record.LinesCovered).ToString("N0"))</td>
                            <td>@record.LinesTotal.ToString("N0")</td>
                            <td class="@GetRateClass(record.LineRate)">@record.LineRate.ToString("P1")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (CoverageService.CurrentReport.ClassDetails.Any())
        {
            <div class="mt-4 d-flex align-items-center justify-content-between">
                <h4 class="h6 text-warning fw-bold mb-0">Target Action Plan & Logic Details</h4>
                <div class="d-flex align-items-center bg-white border rounded px-2 py-1 shadow-sm">
                    <span class="small me-2 text-muted fw-bold">THRESHOLD:</span>
                    <input type="number" class="form-control form-control-sm border-0 bg-transparent text-center" 
                           style="width: 60px; font-weight: bold;" 
                           @bind="CoverageService.CoverageThreshold" min="0" max="100" />
                    <span class="small fw-bold text-muted">%</span>
                </div>
            </div>
            <p class="text-muted small mt-1 mb-2">Toggle <i class="bi bi-bullseye text-primary"></i> to add classes to your <strong>60% Goal Action Plan</strong>.</p>
            
            <div class="table-responsive">
                <table class="table table-striped table-sm table-hover">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Package / Class</th>
                            <th>Uncovered Lines (Impact)</th>
                            <th>Covered / Total</th>
                            <th>Line Rate</th>
                            <th>Complexity</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detail in CoverageService.CurrentReport.ClassDetails.Where(d => d.IsTarget || d.LineRate <= (double)CoverageService.CoverageThreshold / 100.0).OrderByDescending(d => d.IsTarget).ThenByDescending(d => d.LinesTotal - d.LinesCovered))
                        {
                            <tr class="@(detail.IsTarget ? "table-primary" : "")">
                                <td class="text-center">
                                    <button class="btn btn-link btn-sm p-0" @onclick="() => detail.IsTarget = !detail.IsTarget">
                                        <i class="bi @(detail.IsTarget ? "bi-check-circle-fill text-primary" : "bi-circle text-muted")" style="font-size: 1.2rem;"></i>
                                    </button>
                                </td>
                                <td><span class="text-muted small">@detail.PackageName.</span><br /><strong>@detail.ClassName</strong></td>
                                <td class="text-danger fw-bold">@((detail.LinesTotal - detail.LinesCovered).ToString("N0"))</td>
                                <td>@detail.LinesCovered / @detail.LinesTotal</td>
                                <td class="@GetRateClass(detail.LineRate)">@detail.LineRate.ToString("P1")</td>
                                <td>@detail.Complexity.ToString("F2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <div class="border-start border-4 border-warning ps-3 mb-4 mt-5">
        <h2 class="h4">2. WebAPI Controllers (Migration Targets)</h2>
        <p class="text-muted small">Classes that likely need refactoring to a Service layer to enable unit testing.</p>

        <h4 class="h6 mt-3 text-uppercase fw-bold">Controller Package Summaries</h4>
        <div class="table-responsive mb-3">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Package</th>
                        <th>Classes</th>
                        <th>Covered</th>
                        <th>Uncovered</th>
                        <th>Total</th>
                        <th>Line Rate</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var record in CoverageService.CurrentReport.Records.Where(r => r.PackageName.EndsWith(" (Controllers)")))
                    {
                        <tr>
                            <td>@record.PackageName.Replace(" (Controllers)", "")</td>
                            <td>@record.ClassCount</td>
                            <td>@record.LinesCovered.ToString("N0")</td>
                            <td class="text-danger">@((record.LinesTotal - record.LinesCovered).ToString("N0"))</td>
                            <td>@record.LinesTotal.ToString("N0")</td>
                            <td class="@GetRateClass(record.LineRate)">@record.LineRate.ToString("P1")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (CoverageService.CurrentReport.ControllerDetails.Any())
        {
            <div class="alert alert-warning py-2 mb-2 small">
                <strong>Migration Priority:</strong> Controllers with large line counts (Complexity) are high-priority targets for 3-layer architecture migration.
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Controller Class</th>
                            <th>Total Lines (Complexity)</th>
                            <th>Covered</th>
                            <th>Uncovered</th>
                            <th>Line Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detail in CoverageService.CurrentReport.ControllerDetails.OrderByDescending(d => d.LinesTotal))
                        {
                            <tr>
                                <td><span class="text-muted small">@detail.PackageName.</span><br /><strong>@detail.ClassName</strong></td>
                                <td class="fw-bold">@detail.LinesTotal.ToString("N0")</td>
                                <td>@detail.LinesCovered.ToString("N0")</td>
                                <td class="text-danger">@((detail.LinesTotal - detail.LinesCovered).ToString("N0"))</td>
                                <td class="@GetRateClass(detail.LineRate)">@detail.LineRate.ToString("P1")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    private string? ErrorMessage;
    private bool IsSaving;
    private bool IsLoading;

    private double ProgressValue;
    private double HistoricalSpeedBytesPerMs;
    private double EstimatedTimeRemaining;

    protected override async Task OnInitializedAsync()
    {
        var history = await CoverageService.GetHistoryAsync();
        if (history != null && history.Any(h => h.ParseDurationMs > 0 && h.FileSizeBytes > 0))
        {
            // Calculate average speed (bytes per ms) from reports that have performance data
            var validReports = history.Where(h => h.ParseDurationMs > 0 && h.FileSizeBytes > 0).ToList();
            HistoricalSpeedBytesPerMs = validReports.Average(h => (double)h.FileSizeBytes / h.ParseDurationMs);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        ErrorMessage = null;
        CoverageService.CurrentReport = null;
        IsLoading = true;
        ProgressValue = 0;
        EstimatedTimeRemaining = 0;
        StateHasChanged(); // Force UI update to show loader

        try
        {
            var file = e.File;
            // Limit to 100MB
            using var stream = file.OpenReadStream(100 * 1024 * 1024); 
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
            
            // XML parsing can be heavy, let's yield if possible
            await Task.Yield(); 
            
            if (HistoricalSpeedBytesPerMs > 0)
            {
                EstimatedTimeRemaining = file.Size / HistoricalSpeedBytesPerMs;
            }

            var progress = new Progress<double>(p => {
                ProgressValue = p;
                if (HistoricalSpeedBytesPerMs > 0)
                {
                    // Update estimate based on remaining progress
                    EstimatedTimeRemaining = (file.Size / HistoricalSpeedBytesPerMs) * (1.0 - p);
                }
                StateHasChanged();
            });

            CoverageService.CurrentReport = await XmlParser.ParseAsync(content, progress);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error parsing file: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SaveReport()
    {
        if (CoverageService.CurrentReport == null) return;
        IsSaving = true;
        try
        {
            bool confirm = await JS.InvokeAsync<bool>("confirm", 
                $"Saving report for date {CoverageService.CurrentReport.UploadDate:yyyy-MM-dd}. This will overwrite any existing report for this date. Continue?");
                
            if (confirm)
            {
                await CoverageService.SaveReportAsync(CoverageService.CurrentReport);
                await JS.InvokeVoidAsync("alert", "Saved successfully!");
                CoverageService.CurrentReport = null; // Reset
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error saving: {ex.Message}";
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void AutoSelectTargets()
    {
        if (CoverageService.CurrentReport == null) return;

        // Reset all targets first
        foreach (var d in CoverageService.CurrentReport.ClassDetails) d.IsTarget = false;

        long targetCovered = (long)Math.Ceiling(CoverageService.CurrentReport.LinesTotal * 0.60);
        long currentCovered = CoverageService.CurrentReport.LinesCovered;
        long needed = targetCovered - currentCovered;

        if (needed <= 0) return;

        // Sort classes by impact (uncovered lines)
        var candidates = CoverageService.CurrentReport.ClassDetails
            .OrderByDescending(d => d.LinesTotal - d.LinesCovered)
            .ToList();

        long accumulated = 0;
        foreach (var cls in candidates)
        {
            if (accumulated >= needed) break;
            
            cls.IsTarget = true;
            accumulated += (cls.LinesTotal - cls.LinesCovered);
        }
    }
    
    private string GetRateClass(double rate) => rate < 0.5 ? "text-danger" : (rate < 0.8 ? "text-warning" : "text-success");
}

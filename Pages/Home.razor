@page "/"
@using CoverageReport.Application.CQRS
@using CoverageReport.Application.CQRS.Commands
@using CoverageReport.Application.CQRS.Queries
@using CoverageReport.Domain.Models
@inject CoverageReport.Application.CQRS.Dispatcher _dispatcher
@inject CoverageReport.Application.Services.CoverageApplicationService AppService
@inject IJSRuntime JS

<PageTitle>Coverage Report - Upload</PageTitle>

<h1>Upload Coverage Report</h1>

<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">Select Cobertura XML</label>
        <InputFile OnChange="HandleFileSelected" class="form-control" accept=".xml" />
    </div>
    <div class="col-md-6">
        @if (AppService.CurrentReport != null)
        {
            <label class="form-label">Report Date</label>
            <input type="date" class="form-control" @bind="AppService.CurrentReport.UploadDate" />
        }
    </div>
</div>

@if (IsLoading || IsSaving)
{
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-dark bg-opacity-75" style="z-index: 9999;">
        <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="text-white fw-bold mb-2">@LoadingMessage</h4>
        <div class="w-50">
            <div class="progress" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated @(IsSaving ? "bg-success" : "bg-primary")" 
                     role="progressbar" style="width: @ProgressDisplayValue%"></div>
            </div>
            <div class="text-white text-center mt-2 small">@Math.Round(ProgressDisplayValue)% Complete</div>
        </div>
        @if (!IsSaving && EstimatedTimeRemaining > 0)
        {
            <div class="text-white-50 small mt-2">
                Estimated time remaining: @(Math.Round(EstimatedTimeRemaining / 1000.0, 1))s
            </div>
        }
    </div>
}

@if (AppService.CurrentReport != null)
{
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-dark text-white py-3">
            <h5 class="mb-0 fw-bold">Report Configuration</h5>
        </div>
        <div class="card-body bg-light">
            <div class="row align-items-end">
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase">Exclusion Pattern (for Controllers)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-filter"></i></span>
                        <input type="text" class="form-control" value="@AppService.CurrentReport.ExclusionPattern" @oninput="HandlePatternChange" placeholder="e.g. .Controller or WebAPI.Controller" />
                    </div>
                    <div class="form-text">Matching classes will be categorized as "Controllers".</div>
                </div>
                <div class="col-md-6 text-end">
                     <button class="btn btn-primary px-4 fw-bold" @onclick="SaveReport" disabled="@IsSaving">
                        @if (IsSaving) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        SAVE TO HISTORY
                     </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3 shadow-sm border-0">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white py-3">
            <h5 class="mb-0 fw-bold">Coverage Overview</h5>
        </div>
        <div class="card-body bg-light border-bottom">
            <div class="row text-center">
                @{
                    var totalMetrics = AppService.CurrentReport.GetTotalMetrics();
                    var coreMetrics = AppService.CurrentReport.CoreMetrics;
                    var controllerMetrics = AppService.CurrentReport.ControllerMetrics;
                }
                <div class="col-md-3 border-end">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Overall Core Content</div>
                    <div class="h4 mb-0 fw-bold @GetRateClass(totalMetrics.Rate)">@totalMetrics.Rate.ToString("P1")</div>
                    <div class="small text-muted mt-1">@totalMetrics.Covered.ToString("N0") / @totalMetrics.Total.ToString("N0") lines</div>
                    <div class="smaller text-danger">(@((totalMetrics.Total - totalMetrics.Covered).ToString("N0")) uncovered)</div>
                </div>
                <div class="col-md-3 border-end">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Core Logic (Services)</div>
                    <div class="h4 mb-0 text-primary fw-bold">@coreMetrics.Rate.ToString("P1")</div>
                    <div class="small text-muted mt-1">@coreMetrics.Covered.ToString("N0") / @coreMetrics.Total.ToString("N0") lines</div>
                </div>
                <div class="col-md-3 border-end">
                    <div class="text-muted small text-uppercase fw-bold mb-1">WebAPI Controllers</div>
                    <div class="h4 mb-0 text-warning fw-bold">@controllerMetrics.Rate.ToString("P1")</div>
                    <div class="small text-muted mt-1">@controllerMetrics.Covered.ToString("N0") / @controllerMetrics.Total.ToString("N0") lines</div>
                </div>
                <div class="col-md-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Status</div>
                    <div class="h4 mb-0 text-secondary fw-bold">@(totalMetrics.Rate >= 0.6 ? "GOAL REACHED" : "BELOW GOAL")</div>
                </div>
            </div>
        </div>
    </div>

    @if (GetTargetClasses().Any())
    {
        <div class="card mb-4 shadow-sm border-0 border-start border-4 border-warning">
            <div class="card-header bg-warning text-dark py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-bullseye me-2"></i>カバレッジ向上対象 (Target Action Plan)</h5>
                <span class="badge bg-dark text-white">@GetTargetClasses().Count classes</span>
            </div>
            <div class="card-body bg-light">
                @{
                    var targetUncovered = GetTargetClasses().Sum(c => c.LineCoverage.Total - c.LineCoverage.Covered);
                    var totalLines = AppService.CurrentReport.GetTotalMetrics().Total;
                    var potentialBoost = totalLines > 0 ? (double)targetUncovered / totalLines : 0;
                    var currentRate = AppService.CurrentReport.GetTotalMetrics().Rate;
                }
                <div class="row mb-4">
                    <div class="col-md-6 border-end">
                        <div class="p-3 bg-white rounded shadow-sm border-start border-4 border-danger">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Focus Uncovered Lines</div>
                            <div class="h3 mb-0 text-danger fw-bold">@targetUncovered.ToString("N0") <small class="h6 text-muted">lines</small></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-white rounded shadow-sm border-start border-4 border-success">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Potential Coverage Boost</div>
                            <div class="h3 mb-0 text-success fw-bold">
                                +@potentialBoost.ToString("P1")
                                <i class="bi bi-arrow-right mx-2 text-muted small"></i>
                                <span class="h4">@((currentRate + potentialBoost).ToString("P1"))</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm bg-white mb-0">
                        <thead>
                            <tr class="small text-muted">
                                <th>Class Name</th>
                                <th class="text-end">Current Coverage</th>
                                <th class="text-end">Uncovered Lines</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cls in GetTargetClasses().OrderBy(c => c.LineCoverage.Rate))
                            {
                                <tr>
                                    <td class="small fw-bold">@cls.Name</td>
                                    <td class="text-end small @GetRateClass(cls.LineCoverage.Rate)">@cls.LineCoverage.Rate.ToString("P1")</td>
                                    <td class="text-end small text-danger">@((cls.LineCoverage.Total - cls.LineCoverage.Covered).ToString("N0"))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }


    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-info text-dark py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="bi bi-folder2-open me-2"></i>名前空間別カバレッジ (Namespace Coverage)</h5>
            <div class="d-flex align-items-center gap-2">
                <span class="small me-2">Include:</span>
                <div class="input-group input-group-sm" style="width: 150px;">
                    <span class="input-group-text"><i class="bi bi-check-circle"></i></span>
                    <input type="text" class="form-control" @bind="StringIncludeFilter" @bind:event="oninput" placeholder="Keyword..." />
                </div>
                <span class="small ms-2 me-2">Exclude:</span>
                <div class="input-group input-group-sm" style="width: 150px;">
                    <span class="input-group-text"><i class="bi bi-x-circle"></i></span>
                    <input type="text" class="form-control" @bind="StringExclusionFilter" @bind:event="oninput" placeholder="Keyword..." />
                </div>
                <span class="small ms-2 me-2">Filter Coverage:</span>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <span class="input-group-text">Min %</span>
                    <input type="number" class="form-control" @bind="MinNamespaceFilter" min="0" max="100" />
                </div>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <span class="input-group-text">Max %</span>
                    <input type="number" class="form-control" @bind="MaxNamespaceFilter" min="0" max="100" />
                </div>
            </div>
        </div>
        <div class="card-body bg-light">
            <div class="table-responsive">
                <table class="table table-hover table-sm bg-white mb-0">
                    <thead class="table-light">
                        <tr class="user-select-none">
                            <th @onclick='() => SortTable("Namespace", "Namespace")' style="cursor: pointer;">名前空間 (Namespace) <i class="bi @GetSortIcon("Namespace", "Namespace")"></i></th>
                            <th @onclick='() => SortTable("Namespace", "Classes")' style="cursor: pointer;" class="text-end">クラス数 <i class="bi @GetSortIcon("Namespace", "Classes")"></i></th>
                            <th @onclick='() => SortTable("Namespace", "Covered")' style="cursor: pointer;" class="text-end">カバー済み <i class="bi @GetSortIcon("Namespace", "Covered")"></i></th>
                            <th @onclick='() => SortTable("Namespace", "Uncovered")' style="cursor: pointer;" class="text-end">未カバー <i class="bi @GetSortIcon("Namespace", "Uncovered")"></i></th>
                            <th @onclick='() => SortTable("Namespace", "Total")' style="cursor: pointer;" class="text-end">全行数 <i class="bi @GetSortIcon("Namespace", "Total")"></i></th>
                            <th @onclick='() => SortTable("Namespace", "Rate")' style="cursor: pointer;" class="text-center">カバレッジ <i class="bi @GetSortIcon("Namespace", "Rate")"></i></th>
                            <th style="width: 150px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var namespaceGroups = AppService.CurrentReport.AllClasses
                                .GroupBy(c => c.Namespace)
                                .Select(g => {
                                    var total = g.Sum(c => c.LineCoverage.Total);
                                    var covered = g.Sum(c => c.LineCoverage.Covered);
                                    var rate = total > 0 ? (double)covered / total : 0;
                                    return new { Namespace = g.Key, Classes = g, TotalLines = total, CoveredLines = covered, Rate = rate };
                                })
                                .Where(g => {
                                    if (!string.IsNullOrWhiteSpace(StringIncludeFilter) && !(g.Namespace?.Contains(StringIncludeFilter, StringComparison.OrdinalIgnoreCase) ?? false))
                                        return false;
                                    if (!string.IsNullOrWhiteSpace(StringExclusionFilter) && (g.Namespace?.Contains(StringExclusionFilter, StringComparison.OrdinalIgnoreCase) ?? false))
                                        return false;
                                    var ratePct = g.Rate * 100;
                                    return ratePct >= MinNamespaceFilter && ratePct <= MaxNamespaceFilter;
                                });

                            var sortedNamespaces = NamespaceSortColumn switch {
                                "Namespace" => NamespaceSortAscending ? namespaceGroups.OrderBy(g => g.Namespace) : namespaceGroups.OrderByDescending(g => g.Namespace),
                                "Classes" => NamespaceSortAscending ? namespaceGroups.OrderBy(g => g.Classes.Count()) : namespaceGroups.OrderByDescending(g => g.Classes.Count()),
                                "Covered" => NamespaceSortAscending ? namespaceGroups.OrderBy(g => g.CoveredLines) : namespaceGroups.OrderByDescending(g => g.CoveredLines),
                                "Uncovered" => NamespaceSortAscending ? namespaceGroups.OrderBy(g => g.TotalLines - g.CoveredLines) : namespaceGroups.OrderByDescending(g => g.TotalLines - g.CoveredLines),
                                "Total" => NamespaceSortAscending ? namespaceGroups.OrderBy(g => g.TotalLines) : namespaceGroups.OrderByDescending(g => g.TotalLines),
                                "Rate" => NamespaceSortAscending ? namespaceGroups.OrderBy(g => g.Rate) : namespaceGroups.OrderByDescending(g => g.Rate),
                                _ => namespaceGroups.OrderBy(g => g.Namespace)
                            };
                        }
                        @foreach (var group in sortedNamespaces)
                        {
                            var totalLines = group.TotalLines;
                            var coveredLines = group.CoveredLines;
                            var rate = group.Rate;
                            
                            <tr>
                                <td class="fw-bold small">@(string.IsNullOrEmpty(group.Namespace) ? "(Global)" : group.Namespace)</td>
                                <td class="text-end small">@group.Classes.Count().ToString("N0")</td>
                                <td class="text-end small">@coveredLines.ToString("N0")</td>
                                <td class="text-end small text-danger">@((totalLines - coveredLines).ToString("N0"))</td>
                                <td class="text-end small">@totalLines.ToString("N0")</td>
                                <td class="text-center fw-bold @GetRateClass(rate)" style="font-size: 0.9rem;">
                                    @rate.ToString("P1")
                                </td>
                                <td>
                                    <div class="progress" style="height: 6px; margin-top: 8px;">
                                        <div class="progress-bar @(rate < 0.6 ? "bg-danger" : (rate < 0.8 ? "bg-warning" : "bg-success"))" 
                                             role="progressbar" style="width: @(rate * 100)%"></div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @* Class Details Section (Restored) *@
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-secondary text-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="bi bi-file-earmark-text me-2"></i>クラス別詳細 (Class Details)</h5>
            <div class="d-flex align-items-center gap-2">
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="targetsOnly" @bind="ShowTargetsOnly" />
                    <label class="form-check-label small fw-bold text-warning" for="targetsOnly"><i class="bi bi-bullseye me-1"></i>Targets Only</label>
                </div>
                <span class="small me-2">Include:</span>
                <div class="input-group input-group-sm" style="width: 150px;">
                    <span class="input-group-text"><i class="bi bi-check-circle"></i></span>
                    <input type="text" class="form-control" @bind="StringIncludeFilter" @bind:event="oninput" placeholder="Keyword..." />
                </div>
                <span class="small ms-2 me-2">Exclude:</span>
                <div class="input-group input-group-sm" style="width: 150px;">
                    <span class="input-group-text"><i class="bi bi-x-circle"></i></span>
                    <input type="text" class="form-control" @bind="StringExclusionFilter" @bind:event="oninput" placeholder="Keyword..." />
                </div>
                <span class="small ms-2 me-2">Filter Coverage:</span>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <span class="input-group-text">Min %</span>
                    <input type="number" class="form-control" @bind="MinCoverageFilter" min="0" max="100" />
                </div>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <span class="input-group-text">Max %</span>
                    <input type="number" class="form-control" @bind="MaxCoverageFilter" min="0" max="100" />
                </div>
            </div>
        </div>
        <div class="card-body bg-light">
            <div class="table-responsive">
                <table class="table table-hover table-sm bg-white mb-0">
                    <thead class="table-light text-nowrap">
                        <tr class="user-select-none">
                            <th style="width: 60px;" class="text-center"><i class="bi bi-bullseye"></i></th>
                            <th @onclick='() => SortTable("Class", "Class")' style="cursor: pointer;">クラス名 (Class Name) <i class="bi @GetSortIcon("Class", "Class")"></i></th>
                            <th @onclick='() => SortTable("Class", "Type")' style="cursor: pointer;">種別 <i class="bi @GetSortIcon("Class", "Type")"></i></th>
                            <th @onclick='() => SortTable("Class", "Covered")' style="cursor: pointer;" class="text-end">カバー済み <i class="bi @GetSortIcon("Class", "Covered")"></i></th>
                            <th @onclick='() => SortTable("Class", "Uncovered")' style="cursor: pointer;" class="text-end">未カバー <i class="bi @GetSortIcon("Class", "Uncovered")"></i></th>
                            <th @onclick='() => SortTable("Class", "Total")' style="cursor: pointer;" class="text-end">全行数 <i class="bi @GetSortIcon("Class", "Total")"></i></th>
                            <th @onclick='() => SortTable("Class", "Rate")' style="cursor: pointer;" class="text-center">カバレッジ <i class="bi @GetSortIcon("Class", "Rate")"></i></th>
                            <th style="width: 200px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var filteredClasses = AppService.CurrentReport.AllClasses
                                .Where(c => {
                                    if (ShowTargetsOnly && !c.IsTarget) return false;
                                    if (!string.IsNullOrWhiteSpace(StringIncludeFilter) && !c.FullName.Contains(StringIncludeFilter, StringComparison.OrdinalIgnoreCase))
                                        return false;
                                    if (!string.IsNullOrWhiteSpace(StringExclusionFilter) && c.FullName.Contains(StringExclusionFilter, StringComparison.OrdinalIgnoreCase))
                                        return false;
                                    var ratePct = c.LineCoverage.Rate * 100;
                                    return ratePct >= MinCoverageFilter && ratePct <= MaxCoverageFilter;
                                });

                            var sortedClasses = ClassSortColumn switch {
                                "Class" => ClassSortAscending ? filteredClasses.OrderBy(c => c.Name) : filteredClasses.OrderByDescending(c => c.Name),
                                "Type" => ClassSortAscending ? filteredClasses.OrderBy(c => IsExcluded(c) ? 1 : 0) : filteredClasses.OrderByDescending(c => IsExcluded(c) ? 1 : 0),
                                "Covered" => ClassSortAscending ? filteredClasses.OrderBy(c => c.LineCoverage.Covered) : filteredClasses.OrderByDescending(c => c.LineCoverage.Covered),
                                "Uncovered" => ClassSortAscending ? filteredClasses.OrderBy(c => c.LineCoverage.Total - c.LineCoverage.Covered) : filteredClasses.OrderByDescending(c => c.LineCoverage.Total - c.LineCoverage.Covered),
                                "Total" => ClassSortAscending ? filteredClasses.OrderBy(c => c.LineCoverage.Total) : filteredClasses.OrderByDescending(c => c.LineCoverage.Total),
                                "Rate" => ClassSortAscending ? filteredClasses.OrderBy(c => c.LineCoverage.Rate) : filteredClasses.OrderByDescending(c => c.LineCoverage.Rate),
                                _ => filteredClasses.OrderBy(c => c.FullName)
                            };
                        }
                        @foreach (var cls in sortedClasses)
                        {
                            var metrics = cls.LineCoverage;
                            var ratePct = metrics.Rate * 100;
                            <tr class="@(cls.IsTarget ? "table-warning" : "")">
                                <td class="text-center">
                                    <input type="checkbox" @bind="cls.IsTarget" />
                                </td>
                                    <td class="small">
                                        <div class="fw-bold">@cls.Name</div>
                                        <div class="text-muted smaller">@cls.Namespace</div>
                                    </td>
                                    <td>
                                        @if (IsExcluded(cls)) { <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">Controller</span> }
                                        else { <span class="badge bg-primary" style="font-size: 0.65rem;">Core</span> }
                                    </td>
                                <td class="text-end small">@metrics.Covered.ToString("N0")</td>
                                <td class="text-end small text-danger">@((metrics.Total - metrics.Covered).ToString("N0"))</td>
                                <td class="text-end small">@metrics.Total.ToString("N0")</td>
                                <td class="text-center fw-bold @GetRateClass(metrics.Rate)" style="font-size: 0.9rem;">
                                    @metrics.Rate.ToString("P1")
                                </td>
                                <td>
                                    <div class="progress" style="height: 6px; margin-top: 8px;">
                                        <div class="progress-bar @(metrics.Rate < 0.6 ? "bg-danger" : (metrics.Rate < 0.8 ? "bg-warning" : "bg-success"))" 
                                             role="progressbar" style="width: @(metrics.Rate * 100)%"></div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    private string? ErrorMessage;
    private bool IsSaving;
    private bool IsLoading;
    private string LoadingMessage = "";
    private double ProgressDisplayValue = 0;

    private double ProgressValue;
    private double HistoricalSpeedBytesPerMs;
    private double EstimatedTimeRemaining;

    private double MinCoverageFilter = 0;
    private double MaxCoverageFilter = 75;

    private double MinNamespaceFilter = 0;
    private double MaxNamespaceFilter = 75;

    private string StringIncludeFilter = string.Empty;
    private string StringExclusionFilter = string.Empty;
    private bool ShowTargetsOnly = false;

    // Sorting state
    private string ProjectSortColumn = "Project";
    private bool ProjectSortAscending = true;

    private string NamespaceSortColumn = "Namespace";
    private bool NamespaceSortAscending = true;

    private string ClassSortColumn = "FullName";
    private bool ClassSortAscending = true;

    private void SortTable(string table, string column)
    {
        switch (table)
        {
            case "Project":
                if (ProjectSortColumn == column) ProjectSortAscending = !ProjectSortAscending;
                else { ProjectSortColumn = column; ProjectSortAscending = true; }
                break;
            case "Namespace":
                if (NamespaceSortColumn == column) NamespaceSortAscending = !NamespaceSortAscending;
                else { NamespaceSortColumn = column; NamespaceSortAscending = true; }
                break;
            case "Class":
                if (ClassSortColumn == column) ClassSortAscending = !ClassSortAscending;
                else { ClassSortColumn = column; ClassSortAscending = true; }
                break;
        }
    }

    private string GetSortIcon(string table, string column)
    {
        string activeColumn = table switch {
            "Project" => ProjectSortColumn,
            "Namespace" => NamespaceSortColumn,
            "Class" => ClassSortColumn,
            _ => ""
        };
        bool ascending = table switch {
            "Project" => ProjectSortAscending,
            "Namespace" => NamespaceSortAscending,
            "Class" => ClassSortAscending,
            _ => true
        };

        if (activeColumn != column) return "bi-arrow-down-up text-muted opacity-50";
        return ascending ? "bi-sort-up text-primary" : "bi-sort-down text-primary";
    }

    protected override async Task OnInitializedAsync()
    {
        var history = await _dispatcher.DispatchAsync<GetHistoryQuery, List<CoverageReportAggregate>>(new GetHistoryQuery());
        if (history != null && history.Any(h => h.ParseDurationMs > 0 && h.FileSizeBytes > 0))
        {
            var validReports = history.Where(h => h.ParseDurationMs > 0 && h.FileSizeBytes > 0).ToList();
            HistoricalSpeedBytesPerMs = validReports.Average(h => (double)h.FileSizeBytes / h.ParseDurationMs);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        ErrorMessage = null;
        AppService.CurrentReport = null;
        IsLoading = true;
        ProgressDisplayValue = 0;
        LoadingMessage = "Preparing...";
        StateHasChanged();

        try
        {
            var file = e.File;
            long totalSize = file.Size;
            long readSize = 0;
            var buffer = new byte[1024 * 64]; 
            
            LoadingMessage = "Reading XML File...";
            using var stream = file.OpenReadStream(100 * 1024 * 1024);
            using var ms = new System.IO.MemoryStream();
            
            int bytesRead;
            while ((bytesRead = await stream.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                await ms.WriteAsync(buffer, 0, bytesRead);
                readSize += bytesRead;
                ProgressDisplayValue = ((double)readSize / totalSize) * 100;
                StateHasChanged();
            }
            
            ms.Position = 0;
            using var reader = new System.IO.StreamReader(ms);
            var content = await reader.ReadToEndAsync();
            
            LoadingMessage = "Analyzing Coverage Data...";
            var parser = new CoverageReport.Infrastructure.Parsers.CoberturaXmlParser();
            var progress = new Progress<double>(v => {
                ProgressDisplayValue = v * 100;
                StateHasChanged();
            });
            AppService.CurrentReport = await parser.ParseAsync(content, ".Controller", progress);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error parsing file: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SaveReport()
    {
        if (AppService.CurrentReport == null) return;
        IsSaving = true;
        try
        {
            bool confirm = await JS.InvokeAsync<bool>("confirm", 
                $"Saving report for date {AppService.CurrentReport.UploadDate:yyyy-MM-dd}. This will overwrite any existing report for this date. Continue?");
                
            if (confirm)
            {
                ProgressDisplayValue = 0;
                LoadingMessage = "Saving to IndexedDB...";
                var progress = new Progress<int>(v => {
                    ProgressDisplayValue = v;
                    StateHasChanged();
                });
                await _dispatcher.DispatchAsync(new CoverageReport.Application.CQRS.Commands.SaveReportCommand(AppService.CurrentReport, progress));
                await JS.InvokeVoidAsync("alert", "Saved successfully!");
                AppService.CurrentReport = null;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error saving: {ex.Message}";
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void HandlePatternChange(ChangeEventArgs e)
    {
        if (AppService.CurrentReport == null) return;
        var newPattern = e.Value?.ToString() ?? string.Empty;
        AppService.CurrentReport.UpdateExclusionPattern(newPattern);
        StateHasChanged();
    }

    private bool IsExcluded(CoverageReport.Domain.Models.ClassDetail cls)
    {
        var pattern = AppService.CurrentReport?.ExclusionPattern ?? ".Controller";
        return cls.FullName.Contains(pattern, StringComparison.OrdinalIgnoreCase);
    }
    
    private string GetRateClass(double rate) => rate < 0.5 ? "text-danger" : (rate < 0.8 ? "text-warning" : "text-success");

    private List<CoverageReport.Domain.Models.ClassDetail> GetTargetClasses() => AppService.CurrentReport?.AllClasses.Where(c => c.IsTarget).ToList() ?? new();
}
